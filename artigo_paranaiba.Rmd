---
title: "Paranaíba"
author: 
  - "Hilário, OH"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_download: yes
    df_print: paged
    keep_md: yes
    theme: flatly
    toc: true
    toc_depth: 5
    toc_float: true
  pdf_document: 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

#load project env and Rmd necessary libs
# load(file = "~/prjcts/... .RData")

```


 <font size="0.5">**This pipeline integrates public tools available for metagenomic analyses. To share or reproduce this content, please require authors' consent.**  
**Contact:** lgc.edna@gmail.com, heronoh@gmail.com</font> 

# Short introduction

# Bioinformatics

## Load  R libs

```{r, eval=FALSE,echo=TRUE}
# 0 - load libraries and other programs ----
{
  library(dplyr)
  library(tidyr)
  library(tibble)
  library(stringr)
  library(ggplot2)
  library(ggbreak)
  library(phyloseq)
  library(Biostrings)
  library(Matrix)
  library(ShortRead)
  library(future)
  library(ggh4x)
  library(vegan)
  
}



```

## Create project folders

```{r, eval=FALSE,echo=TRUE}
# 0 - load libraries and other programs ----
{  
  #project name radical
  prjct_rad <- c("paranaiba")
    
  
  #project main folder
  analysis_path <- c("/home/heron/prjcts/paranaiba")
    
  # create data_folder
  data_path <- paste0(analysis_path,"/data")
  if(!dir.exists(data_path)){ 
    dir.create(data_path)
  }else{
      print(paste0("The folder data_path already exists"))
    }
  # create results folder
  results_path <- paste0(analysis_path,"/results")
  if(!dir.exists(results_path)){ 
    dir.create(results_path)
  }else{
      print(paste0("The folder results_path already exists"))
    }
  
  # create figs folder
  figs_path <- paste0(results_path,"/figs")
  if(!dir.exists(figs_path)){ 
    dir.create(figs_path)
  }else{
      print(paste0("The folder figs_path already exists"))
    }
  
}

```



## Read final results tables

```{r, eval=FALSE,echo=TRUE}

#tabela final de resultados ----

#tabela retidara de:
#  https://docs.google.com/spreadsheets/d/1w5m5VrRFAi-cocrx1MobRaZjQRgEdmVcjRqmF7RVi_c/edit#gid=2015531953

FINAL_TBL_prnb <- readxl::read_xlsx(path = "~/prjcts/paranaiba/EM118_Paranaiba/results/ecomol-EM118_Paranaiba-complete_analysis_results-2023-01-16.xlsx",
                                           col_names = TRUE,
                                    .name_repair = "minimal",
                                           guess_max = 200) %>% 
  dplyr::rename("BLASTn pseudo-score" = "Blast pseudo-score",
                "Metadata 1" = "Metadata.1",
                "Metadata 2" = "Metadata.2",
                "Metadata 3" = "Metadata.3",
                "Metadata 4" = "Metadata.4",
                "Metadata 5" = "Metadata.5") %>% 
  mutate("Project" = "Paranaíba")


colnames(FINAL_TBL_prnb)


tbl_curadoria <- read.csv(file = "~/prjcts/paranaiba/data/ecomol-EM118_Paranaiba-CURADO-ASVs_Vs_Samples_12abr24.csv",
                          header = TRUE,
                          sep = ",",
                          check.names = F) %>% 
  as_tibble() %>% 
  filter(`ASV present in controls` %in% c("ASV exclusive to samples")) %>% 
  dplyr::rename("Curated ID" = "ID CURADA") %>% 
  select(c("ASV header", "Curated ID", "Observação"))

#  Versão antiga da curadoria
# tbl_curadoria <- readxl::read_xlsx(path = "~/prjcts/paranaiba/data/Curadoria_seq_Parnaiba-mar24.xlsx",
#                                    col_names = TRUE,
#                                    sheet = "Curadoria",
#                                    guess_max = 200) %>% 
#   dplyr::rename("Curated ID" = "Sp. da bacia") %>% 
#   select(c("ASV header", "Curated ID"))

colnames(tbl_curadoria)

```

## Concatenate species curation to final results

```{r, eval=FALSE,echo=TRUE}
# testes ----
tbl_curadoria$`ASV header` 

tbl_curadoria$`ASV header` %>% unique()
tbl_curadoria$`ASV header` %>% duplicated() %>% which()
tbl_curadoria$`ASV header`[tbl_curadoria$`ASV header` %>% duplicated() %>% which()]

tbl_curadoria$`ASV header` %in% FINAL_TBL_prnb$`ASV header`



FINAL_TBL_prnb


FINAL_TBL_prnb %>% 
  filter(`Class (BLASTn)` %in% c("Actinopteri")) %>% 
  # filter(`Blast pseudo-score` >= 90) %>% 
  select(`ASV header`) %>% 
  unique()


# concatenar tabelas ----
FINAL_TBL_prnb_cur <- FINAL_TBL_prnb %>% 
  filter(`Class (BLASTn)` %in% c("Actinopteri")) %>% 
  select(-c("Curated ID")) %>% 
  left_join(y = tbl_curadoria,by = "ASV header") %>% 
  # mutate("Curated ID" = case_when((`Curated ID` %in% c("",NA)) ~ (paste0(`Final ID (BLASTn)`,"--",round(`BLASTn pseudo-score`, digits = 2))),
  mutate("Curated ID" = case_when((`Curated ID` %in% c("",NA)) ~ (paste0(`Final ID (BLASTn)`,"-- Not Cur.")),
                                  TRUE ~ `Curated ID`)) %>% 
  filter(!`Observação` %in% c("Excluida"))
  




FINAL_TBL_prnb_cur %>% 
  filter(`Class (BLASTn)` %in% c("Actinopteri")) %>% 
  # filter(`Curated ID` %in% c("",NA)) %>%
  select("ASV (Sequence)","ASV header","Curated ID","Final ID (BLASTn)","Observação","BLASTn pseudo-score") %>% 
  unique() %>%  View()


```


## Recalculate clean cureted abundances

```{r, eval=FALSE,echo=TRUE}


FINAL_TBL_prnb_cur %>% 
  select(File_name,Sample) %>% View()


FINAL_TBL_prnb_cur$`Final ID (BLASTn)` %>% unique() %>% sort()
FINAL_TBL_prnb_cur$`Curated ID` %>% unique() %>% sort()









FINAL_TBL_prnb_cur_clean <- FINAL_TBL_prnb_cur %>%
    # 
    # mutate("ID status" = case_when(is.na(`Final ID (BLASTn)`) & is.na(`Final ID (DADA2)` ) ~ "not IDed",
    #                                !is.na(`Final ID (BLASTn)`) | !is.na(`Final ID (DADA2)`) ~ "IDed")) %>%
    # mutate("ID status" = case_when(is.na(`Final ID (BLASTn)`) ~ "not IDed",
    #                                !is.na(`Final ID (BLASTn)`) ~ "IDed")) %>%
    mutate("ID status" = case_when(is.na(`Curated ID`) ~ "not IDed",
                                   !is.na(`Curated ID`) ~ "IDed")) %>%

  ################# filtrar especies ################################################################################
    # filter(`Final ID (BLASTn)` %in% c("Homo sapiens","Sus scrofa","Bos taurus"))
  
    # ABD limpa por amostra
    # group_by(Unique_File_name,Primer,`Expected length`,`ID status`, `Possible Metazoa`,`Read origin`
    group_by(
      Sample,
      # `Sample name`,
             `Primer expected length`,`ID status`, `Possible Metazoa`,`Read origin`
             # ,`Possible contamination`
             ) %>%
    # group_by(Sample,`Expected length`,`ID status`, `Possible Metazoa`,`Read origin`,`Possible contamination`) %>%  #WWF
    mutate("Total clean sample abd."  = 0,
           "Total clean sample abd." = case_when((`ID status` %in% c("IDed") & 
                                                        `Primer expected length` %in% c("in range") & 
                                                        `Possible contamination` %in% c("True detection") &
                                                        `Possible Metazoa` == TRUE) ~ sum(`ASV absolute abundance`)
                                                      # (`ID status` %in% "not IDed") ~ 0,
                                                      # (`Expected length` %in% "out of range") ~ 0,
                                                      # (`Possible contamination` %in% "Possible contamination") ~ 0,
                                                      # (`Possible Metazoa` %in% FALSE) ~ 0
                                                      # TRUE ~ 0
                                                      )) %>% 
    ungroup() %>% 
  
  # mutate("Clean relative abd. on sample" =  case_when(`ID status` == "not IDed"  ~ 0,
  #                                                     `Expected length` == "out of range" ~ 0,
  #                                                     `ID status` == "IDed" & 
  #                                                       `Expected length` == "in range" & 
  #                                                       `Possible contamination` == "True detection" &
  #                                                       `Possible Metazoa` == TRUE ~ (`ASV absolute abundance`/`Total clean sample abd.`))) %>% 
  mutate("Clean relative abd. on sample" =  (`ASV absolute abundance`/`Total clean sample abd.`)) %>% 
  mutate("Unique_File_name" = File_name) %>% 
  relocate("File_name","Sample","Primer","Curated ID","Primer expected length","ID status", "Possible Metazoa","Read origin","Possible contamination","Clean relative abd. on sample","Total clean sample abd.") %>% 
  mutate("BLASTn pseudo-score" = `1_indentity` *`1_qcovhsp` /100) %>% 
  mutate("Identification" =  case_when(`BLASTn pseudo-score` >= 98 ~ `Final ID (BLASTn)`,
                                       `BLASTn pseudo-score` >= 95 & `BLASTn pseudo-score` < 98 ~ `Genus (BLASTn)`,
                                       `BLASTn pseudo-score` >= 90 & `BLASTn pseudo-score` < 95 ~ `Family (BLASTn)`,
                                       `BLASTn pseudo-score` >= 80 & `BLASTn pseudo-score` < 90 ~ `Order (BLASTn)`,
                                       `BLASTn pseudo-score` >= 60 & `BLASTn pseudo-score` < 80 ~ `Class (BLASTn)`),
         "Identification Max. taxonomy" =   case_when(`BLASTn pseudo-score` >= 98 ~ "Species",
                                       `BLASTn pseudo-score` >= 95 & `BLASTn pseudo-score` < 98 ~ "Genus",
                                       `BLASTn pseudo-score` >= 90 & `BLASTn pseudo-score` < 95 ~ "Family",
                                       `BLASTn pseudo-score` >= 80 & `BLASTn pseudo-score` < 90 ~ "Order",
                                       `BLASTn pseudo-score` >= 60 & `BLASTn pseudo-score` < 80 ~ "Class")) %>% 
  relocate("Identification","Identification Max. taxonomy","BLASTn pseudo-score")

#order by abundance
colnames(FINAL_TBL_prnb_cur_clean)



FINAL_TBL_prnb_cur_clean %>% 
  select(`Clean relative abd. on sample`,Sample,`Curated ID`) %>%  
  ggplot(aes(x = `Clean relative abd. on sample`, 
             y = Sample, 
             group = Sample,
             fill = `Curated ID`)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = viridis::turbo(n=90),guide = "none")


```




## Reload curated table

```{r, eval=FALSE,echo=TRUE}
# the curation was performed on the IDs_X_Samples tab!!!!


cur_Daniel <- readxl::read_xlsx(path = "~/prjcts/paranaiba/data/Paranaiba-Complete_analysis_results-2024-04-12_tabela_paper.xlsx",
                                              sheet = "IDs X Samples",
                                           col_names = TRUE,
                                    .name_repair = "minimal",
                                           guess_max = 200) 




 cur_Daniel <- cur_Daniel %>% 
 select(c(`Curated ID`,`ASVs in this ID`)) %>% 
   separate_longer_delim(cols = "ASVs in this ID",
                         delim = ",") %>% 
   mutate(`ASVs in this ID` = str_remove_all(`ASVs in this ID`, pattern = " ")) %>% 
   dplyr::rename("ASV header" = "ASVs in this ID") %>% 
   na.exclude()
 
 
 cur_Daniel$`ASV header` %>% duplicated()


```






### Reintegrate ID curation

```{r,echo=TRUE, eval=FALSE}
FINAL_TBL_prnb_cur_clean$`Curated ID` %>% unique() %>% sort()


FINAL_TBL_prnb_cur_clean <- FINAL_TBL_prnb_cur_clean %>% 
  select(-c("Curated ID")) %>% 
  left_join(y = cur_Daniel,
            by = "ASV header") %>%
  dplyr::relocate("Curated ID") %>% 
  mutate(`Curated ID` = case_when(is.na(`Curated ID`)~Identification,
                                  TRUE~`Curated ID`))


FINAL_TBL_prnb_cur_clean$`Curated ID` %>% unique() %>% sort()
FINAL_TBL_prnb_cur_clean %>% colnames()


# FINAL_TBL_prnb_cur_clean$`Family (BLASTn)`[FINAL_TBL_prnb_cur_clean$`Curated ID` %in% c("Apareiodon sp.1")] <- "Parodontidae" 


```






### Resave complete table

```{r,echo=TRUE, eval=FALSE}

FINAL_TBL_prnb_cur_clean %>% 
writexl::write_xlsx(
                    path = paste0(results_path,"/",project_name,"-Complete_analysis_results-",Sys.Date(),".xlsx"),
                    col_names = TRUE,
                    format_headers = TRUE)

```

### Save ASV Vs. Samples table

```{r,echo=TRUE, eval=FALSE}

# generate ASVs Vs. Samples table from complete table ----

#function to either sum or unique by column type ----
##################################################
sum_uniq <- function(vec=vec){
  
  if (is.character(vec)==TRUE) {
    suniq <- BiocGenerics::unique(vec)
  }
  if (is.numeric(vec)==TRUE) {
    suniq <- sum(vec)
  }
  return(suniq)
}
####################################################




# colnames(smp_abd_ID) %>% paste0(collapse = '",\n"') %>% cat()

options(scipen = 10)


# generate ASVs Vs. Samples table from complete table ----

smp_abd_ID_eco <-
FINAL_TBL_prnb_cur_clean %>% 
  mutate("Superkingdom (BLASTn)" = "Eukaryota") %>% 
  
  mutate(Identification = if_else(Identification %in% c(NA,"NA"),"NA",Identification)) %>%
  # mutate(Identification = `Curated ID`) %>%
  dplyr::select(-c("Relative abundance to all samples", 
            "Sample total abundance",
            "ASV absolute abundance",
            # "Metadata 1","Metadata 2","Metadata 3","Metadata 4","Metadata 5","obs",
            # "Curated ID",
            "Identification",
      "Identification Max. taxonomy",
            # "Final ID (BLASTn)",
            # "Final ID (DADA2)",
            # "Extraction.control",
            "PCR control",
            "Prop. to PCR control",
            "Prop. to Ext control",
            "Prop. to Filt control",
            "Possible contamination",
            # "Primer expected length",
            "Type")) %>% 
  pivot_wider(
    id_cols = c(
      "Curated ID",
      "Final ID (BLASTn)",
      "Final ID (DADA2)",
      "Primer","Primer","Read origin","Primer expected length",
                "Possible Metazoa",
                

                        "Kingdom (DADA2)",
                        "Phylum (DADA2)",
                        "Class (DADA2)",
                        "Order (DADA2)",
                        "Family (DADA2)",
                        "Genus (DADA2)",
                        "Species (DADA2)",
                        "Specimen (DADA2)",
                        "Basin (DADA2)",
                        # "Exact Genus/Species (DADA2)",
                
                
             "Superkingdom (BLASTn)",
                "Kingdom (BLASTn)",
                "Phylum (BLASTn)",
                "Subphylum (BLASTn)",
                "Class (BLASTn)",
                "Subclass (BLASTn)",
                "Order (BLASTn)",
                "Suborder (BLASTn)",
                "Family (BLASTn)",
                "Subfamily (BLASTn)",
                "Genus (BLASTn)",
                # "max_tax",
      # "BLAST ID",
      "BLASTn pseudo-score",
                          "1_subject header","1_subject","1_indentity","1_qcovhsp",
                          "1_length","1_mismatches","1_gaps","1_query start","1_query end",
                          "1_subject start","1_subject end","1_e-value","1_bitscore","2_subject header",
                          "2_subject","2_indentity","2_qcovhsp","2_length","2_mismatches",
                          "2_gaps","2_query start","2_query end","2_subject start","2_subject end",
                          "2_e-value","2_bitscore","3_subject header","3_subject","3_indentity",
                          "3_qcovhsp","3_length","3_mismatches","3_gaps","3_query start",
                          "3_query end","3_subject start","3_subject end","3_e-value","3_bitscore",
              # "Contamination control",
      "ASV Size (pb)","ASV header","ASV (Sequence)","OTU"),
    # values_from ="Relative abundance on sample",
    values_from ="Clean relative abd. on sample",
    values_fn = sum_uniq,
    names_from = Unique_File_name,
    names_sort = TRUE,
    names_prefix = "SAMPLE ") %>% 
  relocate(c("Primer",
             "Read origin",
                        "Kingdom (DADA2)",
                        "Phylum (DADA2)",
                        "Class (DADA2)",
                        "Order (DADA2)",
                        "Family (DADA2)",
                        "Genus (DADA2)",
                        "Species (DADA2)",
                        "Specimen (DADA2)",
                        "Basin (DADA2)",
                        # "Exact Genus/Species (DADA2)",
             
             "Superkingdom (BLASTn)",
              "Kingdom (BLASTn)",
             "Phylum (BLASTn)",
             "Subphylum (BLASTn)",
             "Class (BLASTn)",
             "Subclass (BLASTn)",
             "Order (BLASTn)",
             "Suborder (BLASTn)",
             "Family (BLASTn)",
             "Subfamily (BLASTn)",
             "Genus (BLASTn)",
             # "max_tax",
             # "BLAST ID",
      # "Identification",
      # "Identification Max. taxonomy",
             
             
             "Possible Metazoa", 
             "Final ID (BLASTn)",
            "Final ID (DADA2)",
             "BLASTn pseudo-score","Primer expected length","ASV Size (pb)",
             starts_with("SAMPLE ")
             )) %>%  
  mutate_if(is.numeric , replace_na, replace = 0)



smp_abd_ID_eco$`ASV (Sequence)`  
smp_abd_ID_eco$`ASV (Sequence)` %>% unique()


smp_abd_ID_eco %>% 
         writexl::write_xlsx(
                    # path = paste0(results_path,"/",prjct_rad,"-todas_infos_ASVs-",Sys.Date(),".xlsx"),
                    path = paste0(results_path,"/",prjct_rad,"-todas_infos_ASVs-",Sys.Date(),".xlsx"),
                    col_names = TRUE,format_headers = TRUE)


# save as .csv ----
smp_abd_ID_eco %>% 
  write.csv(file = paste0(results_path,"/",prjct_rad,"-todas_infos_ASVs-",Sys.Date(),".csv"),
            sep = ";",
            col.names = TRUE,
            row.names = FALSE)



colnames(smp_abd_ID_eco) %>% paste0(collapse = '",\n"') %>% cat()

```


### Save IDs Vs. Samples table

```{r,echo=TRUE, eval=FALSE}


# generate IDs Vs. Samples table from complete table ----

smp_abd_ID_eco %>% colnames()%>% paste0(collapse = '",\n"') %>% cat()

sum_uniq(vec = smp_abd_ID$`ASV (Sequence)`)
#


FINAL_TBL_prnb_cur_clean %>% 
  filter(`Curated ID` %in% c("Pimelodus maculatus")) %>% 
  pull(`ASV absolute abundance`) %>% 
  sum()



smp_abd_ID_eco_ID <-
  FINAL_TBL_prnb_cur_clean %>%
  # filter(`Read origin` %in% c("R1","R2")) %>%
  filter(`1_indentity` >= 80) %>%
  # filter(Type %in% c("Sample")) %>%
  filter(`Primer expected length` %in% c("in range")) %>%
  filter(`Kingdom (BLASTn)` %in% c("Metazoa")) %>%
  filter(`Class (BLASTn)` %in% c("Actinopteri")) %>%
  # filter((`Possible contamination` %in% c("True detection") & Type %in% c("Sample") ) |Type %in% c("PCR control") ) %>%
  
  mutate("Superkingdom (BLASTn)" = "Eukaryota") %>% 
  
  #percentualize abds
  mutate("ASV % abundance on sample" = `Clean relative abd. on sample`*100) %>% 
  
  group_by(`Curated ID`) %>% 
  mutate("Min. BLASTn pseudo-score" = min(`BLASTn pseudo-score`),
         "Max. BLASTn pseudo-score" = max(`BLASTn pseudo-score`),
         "Num. ASVs in this ID" = length(unique(`ASV (Sequence)`)),
         "ID total abd. on all samples" = sum(`ASV absolute abundance`),
         "ASVs in this ID" = paste0(unique(`ASV header`),collapse = ", "),
         "Num. OTUs in this ID" = length(unique(`OTU`)),
         "OTUs in this ID" = paste0(unique(`OTU`),collapse = ", ")) %>% 
  relocate("Min. BLASTn pseudo-score", "Max. BLASTn pseudo-score","OTU") %>% 
  ungroup() %>%
  # filter(Client %in% c("ICMBio")) %>% 
  # filter(`Read origin` %in% c("merged")) %>% 
  # 
   mutate(Identification = if_else(Identification %in% c(NA,"NA"),"NA",Identification)) %>% 
  dplyr::select(-c("Relative abundance to all samples", 
            "Sample total abundance",
            "ASV absolute abundance",
            # "Metadata 1","Metadata 2","Metadata 3","Metadata 4","Metadata 5","obs",
            # "Curated ID",
            "Identification",
            "Final ID (DADA2)",
            "Final ID (BLASTn)",
            # "Extraction.control",
            "PCR control",
            "Prop. to PCR control",
            "Prop. to Ext control",
            "Prop. to Filt control",
            "Possible contamination",
            "Primer expected length",
            "Type",
            "blast ID Origin",
            # "Read origin",
                       # "BLASTn pseudo-score","Order (BLASTn)","BLAST_subclass","Class (BLASTn)","Phylum (BLASTn)","BLAST_subphylum",
                       # "Kingdom (BLASTn)",
            "1_subject header","1_subject","1_indentity","1_qcovhsp",
                       "1_length","1_mismatches","1_gaps","1_query start","1_query end",
                       "1_subject start","1_subject end","1_e-value","1_bitscore","2_subject header",
                       "2_subject","2_indentity","2_qcovhsp","2_length","2_mismatches",
                       "2_gaps","2_query start","2_query end","2_subject start","2_subject end",
                       "2_e-value","2_bitscore","3_subject header","3_subject","3_indentity",
                       "3_qcovhsp","3_length","3_mismatches","3_gaps","3_query start",
                       "3_query end","3_subject start","3_subject end","3_e-value","3_bitscore",
                       # "Contamination control",
            "ASV Size (pb)","ASV header","ASV (Sequence)","OTU"
            )) %>% 
  pivot_wider(
    id_cols = c("Primer",
                "Read origin",
                # "Identification",
                # 
      "Curated ID",
      # "Final ID (DADA2)",
                
                
                        # "Kingdom (DADA2)",
                        # "Phylum (DADA2)",
                        # "Class (DADA2)",
                        # "Order (DADA2)",
                        # "Family (DADA2)",
                        # "Genus (DADA2)",
                        # "Specimen (DADA2)",
                        # "Species (DADA2)",
                        # "Basin (DADA2)",
                        # "Exact Genus/Species (DADA2)",
                        # 
                        "Min. BLASTn pseudo-score",
      "Max. BLASTn pseudo-score",
                
                "Possible Metazoa",
             "Superkingdom (BLASTn)",
             "Kingdom (BLASTn)",
             "Phylum (BLASTn)",
             "Subphylum (BLASTn)",
             "Class (BLASTn)",
             "Subclass (BLASTn)",
             "Order (BLASTn)",
             "Suborder (BLASTn)",
             "Family (BLASTn)",
             "Subfamily (BLASTn)",
             "Genus (BLASTn)",
                # "BLAST ID","max_tax"
      "ID total abd. on all samples",
      "Num. ASVs in this ID",
      "ASVs in this ID",
      "Num. OTUs in this ID",
      "OTUs in this ID" 
      ),
    # values_from = c("Relative abundance on sample"),
    # values_from = c("ASV % abundance on sample"),
    values_from = c("Clean relative abd. on sample"),
    values_fn = sum_uniq,
    names_from = "Unique_File_name",
    names_prefix = "SAMPLE ",
    names_sort = TRUE) %>% 
  relocate(c("Primer","Primer",
             "Read origin",
             
             
                        # "Kingdom (DADA2)",
                        # "Phylum (DADA2)",
                        # "Class (DADA2)",
                        # "Order (DADA2)",
                        # "Family (DADA2)",
                        # "Genus (DADA2)",
                        # "Specimen (DADA2)",
                        # "Species (DADA2)",
                        # "Basin (DADA2)",
                        # "Exact Genus/Species (DADA2)",
             
             "Superkingdom (BLASTn)",
              "Kingdom (BLASTn)",
             "Phylum (BLASTn)",
             "Subphylum (BLASTn)",
             "Class (BLASTn)",
             "Subclass (BLASTn)",
             "Order (BLASTn)",
             "Suborder (BLASTn)",
             "Family (BLASTn)",
             "Subfamily (BLASTn)",
             "Genus (BLASTn)",
             # "max_tax","BLAST ID",
             "Min. BLASTn pseudo-score",
             "Max. BLASTn pseudo-score",
             "Possible Metazoa", 
             # "Identification",
             # 
      "Curated ID",
      # "Final ID (DADA2)",
      "Num. ASVs in this ID",
      "ASVs in this ID",
      "Num. OTUs in this ID",
      "OTUs in this ID",
             starts_with("SAMPLE "),
      "ID total abd. on all samples",
             )) %>%  
  mutate_if(is.numeric , replace_na, replace = 0) %>% 
  mutate("Total abd. of all IDs" =  sum(`ID total abd. on all samples`),
         "Cur. ID % abd. on all samples" = round(`ID total abd. on all samples`/`Total abd. of all IDs`*100,
                                                    digits = 3))


smp_abd_ID_eco_ID %>% 
writexl::write_xlsx(
                    path = paste0(results_path,"/",prjct_rad,"-todas_infos-IDs-",Sys.Date(),".xlsx"),
                    col_names = TRUE,format_headers = TRUE)



```




## IDs heatmap

```{r, eval=FALSE,echo=TRUE}


curated_smp_abd_ID <- FINAL_TBL_prnb_cur_clean


scales::show_col(viridis::turbo(n=10))

options(scipen = 500,digits = 4)

library(ggh4x)


#factor metadata
curated_smp_abd_ID %>% dplyr::select(starts_with("Metada")) %>% unique()

curated_smp_abd_ID$`Metadata 1` %>% unique() 
curated_smp_abd_ID$`Metadata 6` %>% unique() 
curated_smp_abd_ID$`Metadata 7` %>% unique() 






# for (project in all_projects) {
for (project in c("Paranaíba")) {

project <- "Paranaíba"

project_name <- project %>% str_replace_all(pattern = " ",
                                        replacement = "_")
  
N_samples <-   curated_smp_abd_ID %>%
  filter(str_detect(string = Project, pattern = project)) %>% 
  pull(Unique_File_name) %>% unique() %>% length()


N_IDs <- curated_smp_abd_ID %>%
  filter(str_detect(string = Project, pattern = project)) %>% 
  pull(`Final ID (BLASTn)`) %>% unique() %>% length()



IDs_smpls_heat <- 
curated_smp_abd_ID %>% 
  filter(str_detect(string = Project, pattern = project)) %>%
  # unite(col = "Sample", Sample, Primer,sep = "-",remove = F) %>%
  # # filter(if_else(Primer %in% c("VF2_FR1d;Fish1;Fish2"),
  # #                `Read origin` %in% c("R1","R2"),
  # #                `Read origin` %in% c("merged"))) %>% 
  # mutate(`Read origin` = case_when(`Read origin` %in% c("merged") ~ "",
  #                                  TRUE ~ `Read origin`)) %>% 
  # arrange(`Sample name`) %>% 
  arrange(Unique_File_name) %>% 
  # mutate("Unique_File_name" = factor(Unique_File_name, levels = sample_levels)) %>%
  filter(Type %in% c("Sample")) %>%
  filter(`Clean relative abd. on sample` >= 0.0005) %>%
  filter(`Primer expected length` %in% c("in range")) %>%
  filter(`BLASTn pseudo-score` >= 80) %>%
  filter(`Kingdom (BLASTn)` %in% c("Metazoa")) %>%
  # filter(`Class (BLASTn)` %in% c("Actinopteri")) %>%
  # filter((`Contamination status` %in% c("True detection") & Type %in% c("Sample") ) |Type %in% c("PCR control") ) %>%
  # filter((`Contamination status` %in% c("True detection") )) %>%
                    # filter((!str_detect( string = `Final ID (BLASTn)`,pattern = c("environmental") ))) %>%
  group_by(`Curated ID`,Unique_File_name,`Read origin`) %>%
  # group_by(`Final ID (BLASTn)`,Sample) %>%
  # group_by(`Genus (BLASTn)`,Sample) %>%
  # group_by(Identification,Unique_File_name,`Read origin`) %>%
  # group_by(`Final ID (DADA2)`,Unique_File_name,`Read origin`,`ASV (Sequence)`) %>%
  # group_by(`Final ID (BLASTn)`,sample_Sample,`Read origin`,`ASV (Sequence)`) %>%
  # group_by(`Final ID (BLASTn)`,Unique_File_name,`Read origin`,`ASV (Sequence)`) %>%
  # mutate("Relative abundance on sample sum (%)" = round(sum(`Relative abundance on sample`),digits = 3),
  mutate("Relative abundance on sample sum (%)" = round(sum(`Clean relative abd. on sample`)*100,digits = 3),
         "Num ASVs per ID" = length(unique(`ASV (Sequence)`))) %>% 
  ungroup() %>% 
  group_by(`Curated ID`,`Read origin`) %>%
  # group_by(`Genus (BLASTn)`) %>% 
  mutate("Min BLASTn pseudo-score" = round(min(`BLASTn pseudo-score`),digits = 2)
         ) %>%
  ungroup() %>% 
  select(c("Min BLASTn pseudo-score","Unique_File_name", "Curated ID", "Metadata 1","Metadata 2", "Relative abundance on sample sum (%)", "Family (BLASTn)", "Order (BLASTn)", "Class (BLASTn)")) %>% 
  unique() %>% 
  # filter(`Relative abundance on sample sum (%)` > 0.05) %>%
  # unite(col = ID_score,sep = "   ", `Curated ID`,
  #       `Min. BLASTn pseudo-score`) %>% 
  ggplot(aes( 
    # x = interaction(`Sample name`, Unique_File_name, sep = " - "),
    x = interaction(Unique_File_name, `Metadata 1`, sep = " - "),
    # x = interaction(`Read origin`,Unique_File_name,sep = " "),
    # x = interaction(`Read origin`,Sample,sep = " "),
    # x = `Sample name`,
    # x = str_remove(Sample,pattern = "-MiFish|-MiBird"),
  # ggplot(aes(x=`Metadata 1`,
             # y=`Curated ID`,
             # y=Identification,
             y = interaction(`Curated ID`,`Min BLASTn pseudo-score`,sep = " / ",lex.order = T),
             # y = interaction(`Genus (BLASTn)`,`Min BLASTn pseudo-score`,sep = " / "),
             # y=interaction(`Final ID (DADA2)`,`Final ID (BLASTn)`,sep = " / "),
             # y=`ID_score`,
             fill =`Relative abundance on sample sum (%)`,
             # col=`Possible contamination`,
                                                 # group=`ASV (Sequence)`,
             # group=`Genus (BLASTn)`
             group=`Curated ID`
             # linetype = `Possible contamination`,
             # label = `Num ASVs per ID`
             )) +
  geom_tile(linewidth=0.25,
            height = 0.75,
            width = 0.75) +
  geom_text(aes(label = round(`Relative abundance on sample sum (%)`,digits = 1),
                col = `Relative abundance on sample sum (%)`/ 10),
            size = 1.5
            
             # ,fill="white", label.size = 0.01, col = "Black",show.legend = TRUE
             ) +
  # stat_contour(aes(z=`Possible contamination`),
  #              color = c("#ff000d",NA)) +
  # scale_fill_gradientn(name = "Relative abd.\n on sample (%)",
  scale_fill_gradientn(name = "Abundância relativa\nna amostra (%)",
                       # colours = c("white","dark red","red", "yellow","green","dark green","blue"),
                       colours = c("white", "yellow","green","dark green","blue"),
                       # colours = viridis::viridis(n = 10,direction = -1),
                       values = c(0,1),
                       breaks = c(0.001,0.01, 0.05, 0.25,1,2.5,5,10,25,50,100),
                       na.value ="white",
                       trans="log10")+
  scale_colour_gradientn(name = "Abundância relativa\nna amostra (%)",
                       # colours = c("white","dark red","red", "yellow","green","dark green","blue"),
                       colours = rev(c("white", "yellow","green","dark green","blue")),
                       # colours = viridis::viridis(n = 10,direction = -1),
                       values = c(0,1),
                       breaks = c(0.001,0.01, 0.05, 0.25,1,2.5,5,10,25,50,100),
                       na.value ="white",
                       trans="log10") +
  # scale_colour_manual(values = c("#d91133",NA)) +
  scale_linetype_manual(values=c("solid",NA)) +
  # guides(color = guide_legend(override.aes = list(fill = "white", 
  #                                                 size = 10))) +
  theme_grey(base_line_size = 0.025,base_size = 8) +
  # theme(axis.text.x = element_text(angle = 0,hjust = 1)) +
  xlab("Pontos de coleta") +
  # ylab("Espécies") +
  ylab("BLASTn Identification / Minimum BLASTn pseudo-score") +
  # ylab("Identificação DADA2 / Identificação BLASTn") +
    # scale_y_discrete(limits=rev) +
  ggtitle(label = paste0("LGC - ",project, " - ",Sys.Date()),
          # ggtitle(label = paste0("ECOMOL - ",project, " - ",Sys.Date()),
              # subtitle = "Espécies identificados nas amostras\n             (com BLASTn pseudo-score >= 98% e ASVs de tamanho entre 221 e 256 - apenas cordados)") +                                                                # Change font size
              # subtitle = "Número de ASVs por espécie: Identificações por BLASTn com >= 98% de similaridade") +      
              # subtitle = "Número de ASVs por espécie: Identificações por BLASTn com >= 90% de similaridade & RRA limpo > 0.5%") +      
              # subtitle = "Abundância relativa de cada identificação obtida por BLASTn, sem cortes de abundância") +      
              # subtitle = "Abundância relativa de cada identificação obtida por BLASTn, considerando apenas IDs com BLASTn pseudo-score >= 80% e Abundância relativa >= 0.5%") +      
              subtitle = "Abundância relativa de cada identificação obtida por BLASTn\nIDs com BLASTn pseudo-score >= 80% e RRA >= 0.05%") +      
  # \n ASVs detectadas nos controles negativos já removidas das amostras.
    # facet_grid(rows = vars(`Class (BLASTn)`,`Order (BLASTn)`),
    # facet_grid(rows = vars(`Phylum (BLASTn)`,`Class (BLASTn)`,`Order (BLASTn)`), 
    facet_grid(rows = vars(`Class (BLASTn)`,`Order (BLASTn)`,`Family (BLASTn)`),
    # facet_grid(rows = vars(`Class (DADA2)`,`Order (DADA2)`,`Family (DADA2)`),
    # facet_grid(rows = vars(`Order (BLASTn)`,`Family (BLASTn)`),
               # cols = vars(Primer),
               # cols = vars(Researcher,Project),
               cols = vars(`Metadata 1`),
               # cols = vars(`Metadata 9`,`Metadata 11`,`Metadata 6`,`Metadata 7`),
               # cols = vars(Project,metadata_1),
               # cols = vars(Local,Tratamento),
                                # labeller = labeller(`Metadata 3` = supp.labs),
    # facet_grid(rows = vars(`Possible contamination`,`Read origin`),
               # cols = vars(Origin),
               scale = 'free',space = 'free',
    labeller = label_wrap_gen(width=12)) +
  
  
  # Change font size
              # subtitle = "Espécies identificados nas amostras\n             (com BLASTn pseudo-score >= 98% & RRA >= 0.05) - apenas peixes.") +                                                                # Change font size
  theme(legend.position = "bottom",
        strip.text.y = element_text(size = 10,angle = 0),
        strip.text.x = element_text(size = 10),
        plot.title = element_text(size=12),
        plot.subtitle = element_text(size=10),
        axis.text.y = element_text(size=8),
        axis.title.x =element_text(size=14), 
        axis.title.y =element_text(size=14), 
        axis.text.x = element_text(size=8,angle = 45, hjust = 1),
        legend.text= element_text(size=8),
        legend.title = element_text(size=10),
        legend.key.width = unit(4, 'cm'),
        legend.key.height = unit(0.5, 'cm'),
        panel.border = element_rect(colour = "#000000", fill = NA),
        panel.grid = element_line(colour = "#ffffff",linewidth = 0.01)
        )  +
  geom_vline(xintercept = c(seq(0.5,220.5,1)), linewidth = 0.1) +
  guides(colour="none")
# facet_wrap2(facets = `Phylum (BLASTn)`~ Metadata 1)

# IDs_smpls_heat
# pg <- ggplotGrob(IDs_smpls_heat)
# 
# 
# 
# for(i in which(grepl("strip-r", pg$layout$name))){
#   pg$grobs[[i]]$layout$clip <- "off"
# }
# grid::grid.draw(pg)



ggsave(file = paste0(figs_path,"/",
                     project_name,"-","heatmap","-Sps_BLASTn_abd-CURATED.pdf"),
                     # unique(smp_abd_ID_Final$Project),"/",
                     # unique(smp_abd_ID_Final$Project),"-heatmap","-Sps_BLASTn.pdf",collapse = ""),
     plot = IDs_smpls_heat,
     device = "pdf",
     width = ifelse(N_samples <= 10, 15, (N_samples)+16),
     height = ifelse(N_IDs <= 20, 10, N_IDs/4+12),
     units = "cm",
     limitsize = FALSE,
     dpi = 300)

}


```




## NMDS

```{r, eval=FALSE,echo=TRUE}


curated_smp_abd_ID








devtools::install_github("karthik/wesanderson")
devtools::install_github("gadenbuie/ggpomological")

scales::show_col(ggthemes::calc_pal()(12))

"#004586" "#ff420e" "#ffd320" "#579d1c" "#7e0021" "#83caff" "#314004" "#aecf00" "#4b1f6f" "#ff950e" "#c5000b" "#0084d1"

"#004586"
"#ff420e"
"#ffd320"
"#7e0021"
"#83caff"
"#314004"
"#aecf00"
"#4b1f6f"
"#ff950e" 
"#c5000b" 
"#0084d1"




cores <- c( "P1" = "#30123BFF",
            "P2" = "#4688FBFF",
            "P3" = "#1CE6B3FF",
            "P4" = "#A8FB39FF",
            "P5" = "#FCB336FF",
            "P6" = "#D73606FF")



cores <- c( "P1" = "#3900A4FF",
            "P2" = "#0100BFFF",
            "P3" = "#008AEFFF",
            "P4" = "#01C43BFF",
            "P5" = "#316C00FF",
            "P6" = "#A4A200FF")



scales::show_col(viridis::turbo(n = 60),ncol = 10)
scales::show_col(viridis::turbo(n = 60)[c(1,11,21,31,41,52)],ncol = 6,)

viridis::turbo(n = 60)[c(1,11,21,31,41,52)]




curated_smp_abd_ID %>%colnames()

 
# converter a tabela final de resultados para o formato amplo, compatível com o NMDS ----  
  
    FINAL_tbl_IDs <-
  curated_smp_abd_ID %>%
  filter(Type %in% c("Sample")) %>% 
  
  # mutate("Sample name" = `Metadata 1`) %>% 
  mutate("Sample name" = str_remove_all(Unique_File_name,
                                        pattern = "EM118_")) %>% 
  mutate("agrupador" = `Metadata 1`) %>% 
  ###_______________remover amostras que atrapalham a visualização_______________###
    # filter(!`Sample name` %in% amostras_removidas) %>%
    dplyr::select(-c(      
    "Unique_File_name", # esse é o identificador unico de cada subamostra de um mesmo ponto
    "Sample",
    "File_name",
    "Primer",
    "Project",
    # "Researcher",
    # "Origem",
    # "Marker",
    "Identification Max. taxonomy",
    # "Clean relative abd. on Sampling Unit by marker",
    # "Num. of replicates in Sampling Unit by marker",
    "Total clean sample abd.",
    "Total clean sample abd.",
  ###____________________podemos soma a abd por qqr classe dessas_______________
  ###____________________basta comentar aqui e substituir em     _______________
  ###____________________      names_from = `NOME DA COLUNA`,    _______________
    "OTU",
    # "Superkingdom (BLASTn)",
    "Kingdom (BLASTn)",
    "Phylum (BLASTn)",
    "Subphylum (BLASTn)",
    "Class (BLASTn)",
    "Subclass (BLASTn)",
    "Order (BLASTn)",
    "Suborder (BLASTn)",
    "Family (BLASTn)",
    "Subfamily (BLASTn)",
    "Genus (BLASTn)",
    "Final ID (BLASTn)",
  # "OTU_ID",
    "BLASTn pseudo-score",
    # "Curated ID",                            # estamos usando essa
  
    "Identification",
  ###____________________      outros campos que não precisamos    _______________
                           # "Comentário Curador",
    # "Curador",
    # "Clean relative abd. on sample", 
    "Relative abundance on sample",         
    "Total clean sample abd.",             # abundancia total da amostra
    "ASV absolute abundance",    #abundancia absoluta
    "ASV Size (pb)",
    "Primer expected length",
    "Type",
  ###____________________      infos das IDs do BLASTn    ______________________
    "1_subject header","1_subject","1_indentity","1_qcovhsp","1_length","1_mismatches","1_gaps",
    "1_query start","1_query end","1_subject start","1_subject end","1_e-value","1_bitscore", 
  # "1_staxid",
    "2_subject header","2_subject","2_indentity","2_qcovhsp","2_length","2_mismatches","2_gaps",
    "2_query start","2_query end","2_subject start","2_subject end","2_e-value","2_bitscore", 
  # "2_staxid",
    "3_subject header","3_subject","3_indentity","3_qcovhsp","3_length","3_mismatches","3_gaps",
    "3_query start","3_query end","3_subject start","3_subject end","3_e-value","3_bitscore", 
  # "3_staxid",
  "max_tax",
  ###____________________      Sequencia da ASV    _____________________________
    "ASV (Sequence)", "ASV header",
  
  ###________________ outras infos tecnicas _________________
  # "Project",
  # "Sample",
  "Read origin",
  "Relative abundance to all samples",
  "Sample total abundance",
  "Metadata 1",
  "Metadata 2",
  "Metadata 3",
  "Metadata 4",
  "Metadata 5",
  # "Metadata 6",
  "obs", 
  "Observação", 
  "Possible Metazoa",
  "BLAST ID", 
  "blast ID Origin",
  "ID status", 
    # "Contamination status", 
    # "max_tax",
    "Possible contamination",
    # "Ext. control",
    "PCR control",
    # "Filt. control",
    "Prop. to PCR control",
    "Prop. to Ext control",
    "Prop. to Filt control",
    "ASV present in controls",
  ends_with("(DADA2)"),
  ends_with("(DADA2 bootstrap)")
    )) %>% 
  # colnames()
  pivot_wider(                                #pivotando as IDs de linhas pra colunas
    id_cols = c("Sample name",
                "agrupador"),
    values_from ="Clean relative abd. on sample",            #utilizando abundancias Identificadas
    # values_from ="ASV rel. abd. in Sampling Unit by marker",
    values_fn = sum_uniq,
    # names_from = Identification,
    names_from = `Curated ID`,
    names_sort = TRUE,
    names_prefix = "ID_"
    ) %>% 
  # relocate(c("Sample",
  relocate(c("Sample name",
             starts_with("ID_")
             )) %>%  
    mutate(dplyr::across(starts_with("ID_") , replace_na, replace = 0)) 

# %>% 
  # filter(rowSums(across(starts_with("ID_")))!=0)

#### Check if you have only one row per sample name ----
  FINAL_tbl_IDs$`Sample name` %>% table()

    



FINAL_tbl_IDs %>% colnames() %>% duplicated()


  
#### Check if your samples IDs sum to 1 ----

FINAL_tbl_IDs %>% 
  select(c("Sample name",starts_with("ID_"))) %>% 
  # rowwise() %>%
  mutate("SOMA" = rowSums(select_if(., is.numeric), na.rm = TRUE)) %>% 
  relocate("SOMA") %>% View()
  
  
  
FINAL_tbl_IDs %>%
  select(starts_with(match = "ID")) %>%
  rowSums() %>% plot()
# 
# # 
FINAL_tbl_IDs %>%
    select(starts_with(match = "ID")) %>%
  colSums() %>% plot()


# cores ----
FINAL_tbl_IDs$`Sample name` %>% unique()














#NMDS ----

#refs
# https://rpubs.com/CPEL/NMDS
# 
# 
# FINAL_tbl_IDs$Marker %>% table()

#1- prepare data for entry in vegan ----
# colnames(FINAL_tbl_IDs)

all_IDs_NMDS_tbl <- FINAL_tbl_IDs %>% 
  mutate("Sample number" = 0) %>%
  relocate(
    `Sample number`)

#2- associate sample numbers to sample names ----
for (sample in 1:nrow(all_IDs_NMDS_tbl)) {
  
  all_IDs_NMDS_tbl$`Sample number`[sample] <- sample
  
}


# colnames(all_IDs_NMDS_tbl) 
# colnames(all_IDs_NMDS_tbl) %>% head(12)


#ordenar df usada no NMDS ----
    all_IDs_NMDS_df <- all_IDs_NMDS_tbl %>% 
      # select(base::sort(colnames(.))) %>%
      relocate(c("Sample number",
                 "Sample name",
                 "agrupador",
      #           
      #           "metadata_1", 
      #           "metadata_2", 
      #           "metadata_3", 
      #           "metadata_4", 
      #           "metadata_5", 
      #           "metadata_6",
      #           "metadata_7",
      #           "metadata_8",
      #           "metadata_9",
      #           "metadata_10",
      #            "Project"
                 )) %>%
      as.data.frame() 

#4- name rows as Sample numbers and remove column ----
row.names(all_IDs_NMDS_df) <- all_IDs_NMDS_df$`Sample number`

all_IDs_NMDS_df %>% dim()


colnames(all_IDs_NMDS_df) %>% head()




# correct species names to avoid problems in ploting

colnames(all_IDs_NMDS_df)[4:ncol(all_IDs_NMDS_df)] <- colnames(all_IDs_NMDS_df)[4:ncol(all_IDs_NMDS_df)] %>%
  str_replace_all(pattern = " ",replacement = "_") %>% 
  str_replace_all(pattern = "\\.",replacement = "") %>% 
  str_replace_all(pattern = "\\(",replacement = "") %>% 
  str_replace_all(pattern = "\\)",replacement = "")





        
all_ps_vegan_ord_meta <- metaMDS(veg = all_IDs_NMDS_df[,4:ncol(all_IDs_NMDS_df)],
                                 comm = all_IDs_NMDS_df[,4:ncol(all_IDs_NMDS_df)],
                                 # distance = "bray"
                                 distance = "jspecard"
                                 )

plot(all_ps_vegan_ord_meta)

dim(all_IDs_NMDS_df)

  #retirado daqui!!!!!!!!!!!!!!!!!!!!       https://www.rpubs.com/RGrieger/545184

# meta.envfit <- envfit(all_ps_vegan_ord_meta, all_IDs_NMDS_df[,c("Estado", "Status")], permutations = 999) # this fits environmental vectors
# meta.envfit <- envfit(all_ps_vegan_ord_meta, all_IDs_NMDS_df[,c("Tratamento", "Estágio")], permutations = 999) # this fits environmental vectors
meta.envfit <- envfit(all_ps_vegan_ord_meta, 
                      # all_IDs_NMDS_df[,c("metadata_8", "metadata_9","metadata_10")], 
                      all_IDs_NMDS_df[,c("agrupador","Sample name")], 
                      permutations = 999,
                      na.rm=TRUE) # this fits environmental vectors



# esse é o passo que mais demora
meta.spp.fit <- envfit(all_ps_vegan_ord_meta, all_IDs_NMDS_df[,4:ncol(all_IDs_NMDS_df)], permutations = 999) # this fits species vectors




## envfit in parallel??----

# 
#   future::plan(future::multisession(),      workers = 10)
#   
# meta.spp.fit2 <- furrr::future_map_dfc(.x = all_IDs_NMDS_df[,11:15],
#                                        .f = vegan::envfit,
#                                        ord = all_ps_vegan_ord_meta, 
#                                        permutations = 999,
#                                        .options = furrr::furrr_options(seed = TRUE))
#   all_ps_vegan_ord_meta$species


## ----






site.scrs <- as.data.frame(scores(all_ps_vegan_ord_meta, display = "sites")) %>% 
  mutate("Sample number" = as.double(row.names(.))) %>% 
  # left_join(y = all_IDs_NMDS_df[,c("Sample",
  left_join(y = all_IDs_NMDS_df[,c("Sample name",
                                   "Sample number",
                                   "agrupador"
                                   # "Estado"
                                   # "metadata_2",
                                   # "metadata_3",
                                   # "metadata_4",
                                   # "metadata_5",
                                   # "metadata_6",
                                   # "metadata_7",
                                   # "metadata_8",
                                   # "metadata_9",
                                   # "metadata_10",
                                   # "metadata_11",
                                   # "metadata_12"
                                   )],
            by = "Sample number") 
# %>% 
#   mutate("Unique ID" = str_replace_all(string = `Unique ID`,
#                                        pattern = "SAMPLE_[0-9]++-",replacement = ""))

site.scrs

# determinar centroides ----
scrs <-
  scores(all_ps_vegan_ord_meta, display = "sites")

cent <-
  aggregate(scrs~`agrupador`,data = site.scrs, FUN = "mean")
# %>% 
#   mutate(Status =  factor(Status, levels = c("Sem intervenção", "Com intervenção","Unidade de Conservação")))


#get species pvalues ----
sps_pvals <- tibble("IDs" = names(meta.spp.fit$vectors$pvals),
                    "p-value" = meta.spp.fit$vectors$pvals)


spp.scrs <- as.data.frame(scores(meta.spp.fit, display = "vectors")) %>% 
  mutate("IDs" = rownames(.)) %>% 
  left_join(y = sps_pvals, by = "IDs")

sig.spp.scrs <- spp.scrs %>% 
  filter(`p-value` <=0.05)                   # selecionar para mostrar apenas sps com pval significativo




#calculate ellipses ----
NMDS <- data.frame("MDS1" = all_ps_vegan_ord_meta$points[,1], 
                  "MDS2" = all_ps_vegan_ord_meta$points[,2],
                  "agrupador"= as.factor(all_IDs_NMDS_df$`agrupador`),
                  check.names = FALSE)
                  # "StatEstado"= as.factor(all_IDs_NMDS_df$StatEstado))

NMDS.mean <- aggregate(NMDS[,1:2],list(group=NMDS$`agrupador`),"mean")
# NMDS.mean=aggregate(NMDS[,1:2],list(group=NMDS$StatEstado),"mean")





# funçaõ do vegan de calcular ellipses
veganCovEllipse<-function (cov, 
                           center = c(0, 0), 
                           scale = 1, 
                           npoints = 100) 
  {
    theta <- (0:npoints) * 2 * pi/npoints
    Circle <- cbind(cos(theta), sin(theta))
    t(center + scale * t(Circle %*% chol(cov)))
  }

# dev.off()
# dev.off()
plot(all_ps_vegan_ord_meta)

ord <- ordiellipse(ord = all_ps_vegan_ord_meta, 
                 groups = all_IDs_NMDS_df$`agrupador`,
                 # groups = all_IDs_NMDS_df$StatEstado,
                 display = "sites",
                 kind = "ehull", conf = 0.95, label = T)


# fit <- envfit(all_ps_vegan_ord_meta~Al,varechem,perm=999,display="lc")

# vegan::ordiarrows(ord = all_ps_vegan_ord_meta,
#                   groups = 
#                     )

df_ell <- data.frame()

for(g in levels(NMDS$`agrupador`)){

  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS[NMDS$`agrupador`== g,],
                  veganCovEllipse(cov = ord[[g]]$cov,
                                  center = ord[[g]]$center,
                                  scale = ord[[g]]$scale))),
  "agrupador"=g))
                                # StatEstado=g))
}

# df_ell <- df_ell 
# %>% 
#   mutate(Status =  factor(Status, levels = c("Unidade de Conservação", "Com intervenção","Sem intervenção")))



# fazer o grafico ----

# library(ggalt)
# 
# # 
# colorblindcheck::palette_check(c("#fcca03","#6b0000","#02cc37"), plot = TRUE)
# colorblindcheck::palette_check(c("#D7E405","#9C0000","#17B102"), plot = TRUE)

# site.scrs <- site.scrs 
# %>% 
#   mutate(Status =  factor(Status, levels = c("Unidade de Conservação", "Com intervenção","Sem intervenção")))


  # paste0(unique(all_IDs_NMDS_df$`metadata_2`),collapse = " / ")

manual_NMDS_plot <-
  ggplot(data = site.scrs, 
         aes(x=NMDS1, 
             y=NMDS2)) +
  #elipses ####
  # ggforce::geom_mark_ellipse(inherit.aes = FALSE,
  #                            data = df_ell,
  #                            aes(x = NMDS1,
  #                                y = NMDS2,
  #                                group=`agrupador`,
  #                                label=`agrupador`,
  #                                col =`agrupador`,
  #                                fill =`agrupador`
  #                                ),
  #                            alpha=0.15,
  #                            # n = 200, 
  #                            linetype=2,
  #                            # expand = unit(5, "px"),
  #                            expand = 0,
  #                            label.fontsize = 18,
  #                            con.cap = 0.1
  #                            ) +
  #hulls #########
  # ggforce::geom_mark_hull(aes(fill=Metadata.2),
  #                         concavity = 5,
  #                         expand=0,
  #                         radius=0,
  #                         linetype=0,
  #                         alpha=0.15
  #                         )+
  #vetores das IDs
  geom_segment(data = sig.spp.scrs, aes(x = 0,
                                        xend=NMDS1,
                                        y=0,
                                        yend=NMDS2),
               arrow = arrow(length = unit(0.1, "cm")),
               colour = "grey10",
               alpha=0.1,
               lwd=0.3) + #add vector arrows of significant species
  # #nomes das IDs
  ggrepel::geom_text_repel(data = sig.spp.scrs,
                           aes(x=NMDS1, y=NMDS2, label = IDs),
                           size=2,
                           alpha= 0.75,
                           # cex = 5,
                           direction = "both",
                           segment.size = 0.25,
                           segment.alpha=0.1,
                           max.overlaps = 100) +
  #pontos amostrais
  geom_point(aes(x=NMDS1, 
                 y=NMDS2, 
                 fill = `agrupador`,
                 col = `agrupador`,
                 # label = `Unique ID`,
                 # alpha = 0.75,
                 group = `agrupador`,
                 # shape = `agrupador`
                 ), 
             stroke = 0.5,
             alpha=0.75,
             # col="#656565",
             size = 5
             # size = `metadata_8`
             )+ 
  #nomes dos pontos amostrais
  geom_text(aes(label = `Sample name`),
  # geom_text(aes(label = interaction(`Sample name`, `metadata_1`,sep = "\n")),
            hjust=0.5, 
            vjust=2.75, 
            size=2) +
  #centroides ----
  geom_point(data = cent,
             aes(x=NMDS1, 
                 y=NMDS2, 
               # colour = Metadata.2,
               fill = `agrupador`
               ),
               size= 1,
               colour="#222222",
               alpha=0.75,
               shape = 23
           )+
  coord_fixed()+
  # scale_colour_manual(values = c("#fcca03","#6b0000","#02cc37"))+
  # scale_fill_manual(values = c("#d65d00", "#fa9141","#92fa37", "#5000b8", "#8129f2" )) +
  # scale_colour_manual(values = c("#d65d00", "#fa9141","#92fa37", "#5000b8", "#8129f2" )) +
  scale_fill_manual(values = cores) +
  scale_colour_manual(values = cores) +
  # scale_fill_manual(values = viridis::turbo(n = 5)) +
  # scale_colour_manual(values = viridis::turbo(n = 5)) +
  # scale_shape_manual(values = formas) +
  # scale_shape_manual(values = c(21,24,25)) +
  # scale_shape_manual(values = c(21,22,23,24,25,13)) +
  # Elipses ###################################################################
  # elipse calculada usando função do vegan, bem menor
  # geom_path(data=df_ell, aes(x=NMDS1, y=NMDS2,colour=Metadata.2), size=0.5, linetype=2) +
  # ADD ggforce's ellipses
              # ggforce::geom_mark_ellipse(inherit.aes = FALSE,
              #                            data = df_ell,
              #                            aes(x = NMDS1,y = NMDS2,
              #                                group=Metadata.2,
              #                                label=Metadata.2,
              #                                col =Metadata.2,
              #                                fill =Metadata.2
              #                            ),
              #                            alpha=0.025,
              #                            n = 200, linetype=2,
              #                            expand = 0,
              #                            label.fontsize = 18,
              #                            label.colour = "#919191",
              #                            con.cap = 0.1
                                  # ) +
# ggplot2::geom_polygon(data = df_ell,inherit.aes = F,
#                       aes(x=NMDS1,
#                           y=NMDS2,
#                           group  = Metadata.2,
#                                              col =Metadata.2),linetype=2)+
  # scale_fill_manual(values = c("#fcca03","#6b0000","#02cc37"))+
                    # )+
  theme_light()+ 
  # labs(colour = "Intervenção", 
  #      shape = "Local") + 
  theme(legend.position = "right", 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 12), 
        axis.text = element_text(size = 10)) +
  # notação do valor do stress do NMDS
  # annotate(geom = "text",
  #          x=c(-0.25),
  #          y=c(-0.25),
  #          label=c(paste0("Stress: ",format(round(all_ps_vegan_ord_meta$stress,4)))),
  #          size=8,col="#919191") +
  # labs(title  = paste0(prjct_rad, " - NMDS das identificações por BLASTn"),
  labs(title  = paste0("NMDS of curated IDs "),
          subtitle = paste0(
            # "\nConsiderando ",
            #                 # "%ID >= 90 e %Abd. >= 0.005,", 
            #                 " todas identificações de Vertebrados e Invertebrados",
                            # " identificações de Aves e Mamíferos",
                            # " identificações de Aves",
                            # " identificações de Peixes",
                            # " identificações de Mamíferos",
                            "\n","Stress: ",format(round(all_ps_vegan_ord_meta$stress,4)))) +
  theme(plot.title = element_text(size = 20)) +
  theme(plot.subtitle = element_text(size = 16)) +
  theme(legend.title = element_text(size = 12)) +
  theme(legend.text =  element_text(size = 12)) +
  theme(axis.title = element_text(size = 16)) +
  # theme(legend.position = "bottom") +
  #          labs(caption = paste0("Amostras removidas:\n"
  #                                # ,
  #                                # paste0(amostras_removidas,collapse = ", ")
  #                                )) +
  guides(fill=guide_legend(title="Sample"),
         col=guide_legend(title="Sample"),
         shape=guide_legend(title="Sample"))
  
manual_NMDS_plot



#get plot area dims ---- 
plot_dims <- DeLuciatoR::get_dims(manual_NMDS_plot,
                     maxheight = 50,
                     maxwidth = 50,
                     units = "cm")


#save plot ----
ggsave(file = paste0(figs_path,"/",
                     prjct_rad,
                     "-",
                     "NMDS_manual-abd_limpa",
                     # "-", "id90", "-",
                     "-", Sys.Date(), ".pdf", collapse = ""),
     plot = manual_NMDS_plot,
     device = "pdf",
     units = "cm",
     width = (plot_dims$width * 0.4),
     height = (plot_dims$height * 0.4),
     dpi = 300, limitsize = FALSE)




# ggplot_build(manual_NMDS_plot)




#quais amostras est'ao atrapalhando?

View(site.scrs)

all_IDs_NMDS_df %>% colnames() %>% duplicated()
all_IDs_NMDS_df$ID_Apareiodon_sp2 %>% jspecarize()



all_IDs_NMDS_df_jc <- all_IDs_NMDS_df %>%
  # as_tibble()
  mutate(across(starts_with('ID_'), jspecarize))


jspecarize <- function(x) {
  # Using ifelse to check each element of the vector x
  ifelse(x == 0, 0, 1)
}





data <- tibble(
  col1 = c(0, 1, 2, 0.555, -1),
  col2 = c(-1, 0, 2, 0, 3),
  col3 = c(1, 1, 0, 0, -2)
)

data %>%
  mutate(across(ends_with('3'), jspecarize))



all_IDs_NMDS_df$ID_Apareiodon_sp1 %>% jspecarize()

spec <- vegan::specaccum(comm = all_IDs_NMDS_df_jc[,4:ncol(all_IDs_NMDS_df_jc)],
          method = "collector")


plot(spec)

#creating a dataframe for ggplot2
data <- data.frame(Sites=spec$sites, Richness=spec$richness, SD=spec$sd)

ggplot() +
  geom_point(data=data, aes(x=Sites, y=Richness)) +
  geom_line(data=data, aes(x=Sites, y=Richness)) +
  geom_ribbon(data=data ,aes(x=Sites, ymin=(Richness-2*SD),ymax=(Richness+2*SD)),alpha=0.2)

```














